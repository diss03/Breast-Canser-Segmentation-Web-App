name: Проверка Git соглашений

on:
  push:
    branches-ignore:
      - main
      - develop
  pull_request:
    types: [ opened, edited, synchronize ]

jobs:
  check-branch-name:
    name: Проверка имени ветки
    runs-on: ubuntu-latest
    steps:
      - name: Проверить имя ветки
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Проверяем ветку: $BRANCH_NAME"
          
          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix)/(analysis|backend|frontend|devops|docs|deps|test|core)-.+$|^release/.+$|^hotfix/.+$ ]]; then
            echo "❌ Ошибка: Неправильный формат названия временной ветки"
            echo "Формат: <временная_ветка>/<область>-<описание>`"
            echo "Временные_ветки: feature, bugfix, hotfix, release"
            echo "Области: analysis, backend, frontend, devops, docs, deps, test, core"
            echo " Пример: `features/analysis-train-model`"
            echo ""
            echo "Обратите внимание! После «:» обязателен пробел"
            echo "• После префикса обязателен слеш /"
            echo "• После области обязателен дефис -"
            echo "• Описание должно содержать хотя бы один символ"
            echo ""
            exit 1
          else
            echo "✅ Название ветки корректно"
          fi

  check-pr-title:
    name: Проверка названия PR
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Проверить название PR
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Проверяем название PR: $PR_TITLE"
          
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|style|refactor|chore)\((analysis|backend|frontend|devops|docs|deps|test|core)\):\ .+$ ]]; then
            echo "❌ Ошибка: Неправильный формат названия PR"
            echo "Формат: <тип>(<область>): <описание>"
            echo "Типы: feat, fix, style, refactor, chore"
            echo "Область: analysis, backend, frontend, devops, docs, deps, test, core"
            echo "Пример: feat(analysis): обучение CNN модели"
            echo ""
            echo "Обратите внимание!"
            echo "• После «:» обязателен пробел"
            echo "• Описание должно содержать хотя бы один символ"
            echo ""
            exit 1
          else
            echo "✅ Название PR корректно"
          fi

  check-commit-messages:
    name: Проверка сообщений коммитов
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Проверить сообщения коммитов
        run: |
          # Получаем список коммитов:
          # • в PR — все коммиты от базовой ветки до HEAD
          # • при push — последние 5 коммитов
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..HEAD)
          else
            COMMITS=$(git log --format=%s -n 5)
          fi

          echo "Проверяем коммиты:"
          echo "$COMMITS"
          echo ""

          ERROR=0
          while IFS= read -r commit; do
            # Строгая проверка по новым правилам:
            # <тип>(<область>): <описание>
            if [[ ! "$commit" =~ ^(feat|fix|style|refactor|chore)\((analysis|backend|frontend|devops|docs|deps|test|core)\):\ .+$ ]]; then
              echo "❌ Ошибка в коммите: $commit"
              echo "   Требуемый формат: <тип>(<область>): <описание>"
              echo "   Типы:     feat, fix, style, refactor, chore"
              echo "   Области:  analysis, backend, frontend, devops, docs, deps, test, core"
              echo "   Пример:   feat(analysis): добавить модель CNN"
              echo ""
              echo "   Обратите внимание:"
              echo "   • после «:» обязателен один пробел"
              echo "   • описание должно содержать хотя бы один символ"
              echo ""
              ERROR=1
            fi
          done <<< "$COMMITS"

          if [ $ERROR -eq 1 ]; then
            echo "❌ Проверка коммитов не пройдена"
            exit 1
          else
            echo "✅ Все коммиты соответствуют принятым правилам"
          fi